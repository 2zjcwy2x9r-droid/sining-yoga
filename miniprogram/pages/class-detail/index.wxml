<!--pages/class-detail/index.wxml-->
<view class="container">
  <view wx:if="{{loading}}" class="loading">
    <text>åŠ è½½ä¸­...</text>
  </view>

  <view wx:else class="content">
    <!-- è¯¾ç¨‹ä¿¡æ¯å¡ç‰‡ -->
    <view class="class-card">
      <view class="class-header">
        <text class="class-name">{{classInfo.name}}</text>
        <view class="class-status {{classInfo.available ? 'available' : 'full'}}">
          {{classInfo.available ? 'å¯é¢„è®¢' : 'å·²æ»¡'}}
        </view>
      </view>

      <view class="class-info-section">
        <view class="info-row">
          <text class="info-label">ğŸ‘¤ è€å¸ˆ</text>
          <text class="info-value">{{classInfo.instructor}}</text>
        </view>
        <view class="info-row">
          <text class="info-label">ğŸ• æ—¶é—´</text>
          <text class="info-value">{{classInfo.start_time || ''}} - {{classInfo.end_time || ''}}</text>
        </view>
        <view class="info-row">
          <text class="info-label">ğŸ‘¥ äººæ•°</text>
          <text class="info-value">{{classInfo.booked_count}}/{{classInfo.capacity}}äºº</text>
        </view>
      </view>

      <view wx:if="{{classInfo.description}}" class="description-section">
        <text class="section-title">è¯¾ç¨‹ä»‹ç»</text>
        <text class="description">{{classInfo.description}}</text>
      </view>

      <view class="instructor-section">
        <text class="section-title">è€å¸ˆä»‹ç»</text>
        <text class="instructor-info">{{classInfo.instructor}}è€å¸ˆæ‹¥æœ‰ä¸°å¯Œçš„ç‘œä¼½æ•™å­¦ç»éªŒ...</text>
      </view>
    </view>

    <!-- æ“ä½œæŒ‰é’® -->
    <view class="action-buttons">
      <button 
        wx:if="{{!userBooking && classInfo.available}}"
        class="btn btn-primary"
        bindtap="bookClass"
      >
        ç«‹å³é¢„è®¢
      </button>
      <button 
        wx:if="{{userBooking && userBooking.status === 'confirmed'}}"
        class="btn btn-cancel"
        bindtap="cancelBooking"
      >
        å–æ¶ˆé¢„è®¢
      </button>
      <button 
        wx:if="{{userBooking}}"
        class="btn btn-review"
        bindtap="showReview"
      >
        {{userReview ? 'æŸ¥çœ‹è¯„ä»·' : 'è¯„ä»·è¯¾ç¨‹'}}
      </button>
    </view>

    <!-- è¯„ä»·åˆ—è¡¨ -->
    <view class="reviews-section">
      <view class="section-header">
        <text class="section-title">è¯¾ç¨‹è¯„ä»·</text>
        <text class="review-count">({{reviews.length}})</text>
      </view>

      <view wx:if="{{reviews.length === 0}}" class="empty-reviews">
        <text>æš‚æ— è¯„ä»·</text>
      </view>

      <view wx:for="{{reviews}}" wx:key="id" class="review-item">
        <view class="review-header">
          <text class="review-user">{{item.user_name || 'åŒ¿åç”¨æˆ·'}}</text>
          <view class="review-rating">
            <text wx:for="{{5}}" wx:key="*this" class="star {{index < item.rating ? 'filled' : ''}}">â˜…</text>
          </view>
        </view>
        <text wx:if="{{item.content}}" class="review-content">{{item.content}}</text>
        <view wx:if="{{item.images && item.images.length > 0}}" class="review-images">
          <image 
            wx:for="{{item.images}}" 
            wx:for-item="img"
            wx:key="*this"
            src="{{img}}"
            mode="aspectFill"
            class="review-image"
            bindtap="previewImage"
            data-urls="{{item.images}}"
            data-current="{{img}}"
          />
        </view>
        <text class="review-time">{{formatDateTime(item.created_at)}}</text>
      </view>
    </view>
  </view>

  <!-- è¯„ä»·å¼¹çª— -->
  <view wx:if="{{showReviewModal}}" class="modal-overlay" bindtap="closeReviewModal">
    <view class="modal-content" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">è¯„ä»·è¯¾ç¨‹</text>
        <text class="modal-close" bindtap="closeReviewModal">âœ•</text>
      </view>

      <view class="modal-body">
        <view class="rating-section">
          <text class="rating-label">è¯„åˆ†</text>
          <view class="rating-stars">
            <text 
              wx:for="{{5}}" 
              wx:key="*this"
              class="star-input {{index < reviewForm.rating ? 'filled' : ''}}"
              bindtap="onRatingChange"
              data-value="{{index + 1}}"
            >â˜…</text>
          </view>
        </view>

        <view class="content-section">
          <text class="content-label">è¯„ä»·å†…å®¹</text>
          <textarea 
            class="content-input"
            placeholder="è¯·è¾“å…¥æ‚¨çš„è¯„ä»·..."
            value="{{reviewForm.content}}"
            bindinput="onReviewContentInput"
            maxlength="500"
          />
        </view>

        <view class="images-section">
          <text class="images-label">ä¸Šä¼ å›¾ç‰‡ï¼ˆå¯é€‰ï¼Œæœ€å¤š3å¼ ï¼‰</text>
          <view class="images-upload">
            <view 
              wx:for="{{reviewForm.images}}" 
              wx:key="*this"
              class="image-preview"
            >
              <image src="{{item}}" mode="aspectFill" class="preview-img" />
              <text class="remove-img" bindtap="removeImage" data-index="{{index}}">âœ•</text>
            </view>
            <view 
              wx:if="{{reviewForm.images.length < 3}}"
              class="image-upload-btn"
              bindtap="chooseImages"
            >
              <text>+</text>
            </view>
          </view>
        </view>
      </view>

      <view class="modal-footer">
        <button class="btn btn-cancel" bindtap="closeReviewModal">å–æ¶ˆ</button>
        <button class="btn btn-primary" bindtap="submitReview">æäº¤</button>
      </view>
    </view>
  </view>
</view>

